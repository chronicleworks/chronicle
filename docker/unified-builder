# syntax = docker/dockerfile:1.4
# Copyright (c) 2022-23 Blockchain Technology Partners, LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
ARG RUST_VERSION=1.68
FROM --platform=${BUILDPLATFORM} rust:${RUST_VERSION} as hostbase

ENV PKG_CONFIG_ALLOW_CROSS=1
ENV OPENSSL_STATIC=true

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
  --mount=type=cache,target=/var/lib/apt,sharing=locked \
  apt-get update \
  && apt-get install -y --no-install-recommends \
  build-essential \
  cmake \
  g++-x86-64-linux-gnu \
  g++-aarch64-linux-gnu \
  libpq5 \
  libpq-dev \
  protobuf-compiler

RUN rustup target add aarch64-unknown-linux-gnu \
  && rustup target add x86_64-unknown-linux-gnu

WORKDIR /app
RUN useradd -m tester \
  && chown -R tester /app

COPY .cargo /app/.cargo
COPY Cargo.lock /app
COPY Cargo.toml /app
COPY crates /app/crates
COPY domain_docs /app/domain_docs
COPY policies /app/policies


FROM --platform=${BUILDPLATFORM} hostbase AS crossbuild
ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG TARGETARCH
ARG BUILD_ARGS

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
  --mount=type=cache,target=/var/lib/apt,sharing=locked \
  dpkg --add-architecture ${TARGETARCH} \
  && apt-get update \
  && apt-get install -y --no-install-recommends \
  liblzma-dev \
  libpq-dev \
  libssl-dev \
  libzmq3-dev

USER root
RUN --mount=type=cache,target=/usr/local/cargo/registry,sharing=locked \
  mkdir -p /artifacts/${TARGETARCH} \
  && chown -R tester \
  /usr/local/cargo/registry \
  /app \
  /artifacts

# If we are doing a cross build, then build once on the host architecture
# so we get the build script dependencies compiled and cached
USER tester
RUN --mount=type=cache,target=/usr/local/cargo/registry,sharing=locked \
  if [ "${TARGETPLATFORM}" != "${BUILDPLATFORM}" ]; then \
  if [ "${BUILDPLATFORM}" = "linux/arm64" ]; then \
  export INITIAL_BUILD_TARGET=aarch64-unknown-linux-gnu; \
  elif [ "${BUILDPLATFORM}" = "linux/amd64" ]; then \
  export INITIAL_BUILD_TARGET=x86_64-unknown-linux-gnu; \
  else \
  echo "Unsupported architecture: ${TARGETPLATFORM}"; \
  exit 1; \
  fi \
  && cargo build --locked --release --target ${INITIAL_BUILD_TARGET} ${BUILD_ARGS} ; \
  fi 

# Now we shuffle out the target architecture dev libraries, but
# only if we are targeting other than the host architecture
USER root
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
  --mount=type=cache,target=/var/lib/apt,sharing=locked \
  if [ "${TARGETPLATFORM}" != "${BUILDPLATFORM}" ]; then \
  apt-get remove -y \
  liblzma-dev \
  libpq-dev \
  libssl-dev \
  libzmq3-dev \
  && apt-get install -y --no-install-recommends \
  liblzma-dev:${TARGETARCH} \
  libpq-dev:${TARGETARCH} \
  libssl-dev:${TARGETARCH} \
  libzmq3-dev:${TARGETARCH} ; \
  fi

# Finally we build the target architecture binaries
# If our target is the host architecture, then this is the
# first build, otherwise it is the second
USER tester
RUN --mount=type=cache,target=/usr/local/cargo/registry,sharing=locked \
  mkdir -p /artifacts/${TARGETARCH} \
  && if [ "${TARGETPLATFORM}" = "linux/arm64" ]; then \
  export CARGO_BUILD_TARGET=aarch64-unknown-linux-gnu; \
  elif [ "${TARGETPLATFORM}" = "linux/amd64" ]; then \
  export CARGO_BUILD_TARGET=x86_64-unknown-linux-gnu; \
  else \
  echo "Unsupported architecture: ${TARGETPLATFORM}"; \
  exit 1; \
  fi \
  && cargo build --locked --release --target ${CARGO_BUILD_TARGET} ${BUILD_ARGS} \
  && mv -f target/${CARGO_BUILD_TARGET}/release/chronicle /artifacts/${TARGETARCH} \
  && mv -f target/${CARGO_BUILD_TARGET}/release/chronicle_sawtooth_tp /artifacts/${TARGETARCH} \
  && mv -f target/${CARGO_BUILD_TARGET}/release/chronicle-domain-lint /artifacts/${TARGETARCH} \
  && mv -f target/${CARGO_BUILD_TARGET}/release/opactl /artifacts/${TARGETARCH} \
  && mv -f target/${CARGO_BUILD_TARGET}/release/opa-tp /artifacts/${TARGETARCH}


FROM --platform=${BUILDPLATFORM} crossbuild AS test
ARG BUILDPLATFORM
ARG BUILD_ARGS

# Test on the host only
# PostgreSQL will not run as root
WORKDIR /app

USER root
RUN --mount=type=cache,target=/usr/local/cargo/registry,sharing=locked \
  chown -R tester /usr/local/cargo/registry

USER tester
RUN --mount=type=cache,target=/usr/local/cargo/registry,sharing=locked \
  if [ "$BUILDPLATFORM" = "linux/arm64" ]; then \
  export CARGO_BUILD_TARGET=aarch64-unknown-linux-gnu; \
  elif [ "$BUILDPLATFORM" = "linux/amd64" ]; then \
  export CARGO_BUILD_TARGET=x86_64-unknown-linux-gnu; \
  else \
  echo "Unsupported architecture: $(BUILDPLATFORM)"; \
  exit 1; \
  fi \
  && cargo test --locked --release --target ${CARGO_BUILD_TARGET}


FROM --platform=${TARGETPLATFORM} rust:${RUST_VERSION} as artifacts
COPY --from=crossbuild --link /artifacts /artifacts


FROM --platform=${TARGETPLATFORM} rust:${RUST_VERSION} as chronicle-builder
ARG TARGETARCH

ENV PKG_CONFIG_ALLOW_CROSS=1
ENV OPENSSL_STATIC=true

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
  --mount=type=cache,target=/var/lib/apt,sharing=locked \
  apt-get update \
  && apt-get install -y --no-install-recommends \
  build-essential \
  cmake \
  libpq-dev \
  libssl-dev \
  libzmq3-dev \
  protobuf-compiler

COPY --from=artifacts /artifacts/${TARGETARCH}/chronicle-domain-lint /usr/local/bin

COPY .cargo /app/.cargo
COPY Cargo.lock /app
COPY Cargo.toml /app
COPY crates /app/crates
COPY domain_docs /app/domain_docs
COPY policies /app/policies

WORKDIR /app
RUN cargo fetch --locked

FROM --platform=${TARGETPLATFORM} debian:bullseye-slim AS final-base
ARG TARGETARCH

RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
  --mount=type=cache,target=/var/lib/apt,sharing=locked \
  apt-get update \
  && apt-get install -y --no-install-recommends \
  ca-certificates \
  libpq5

VOLUME /var/lib/chronicle
RUN groupadd -g 999 chronicle && \
  useradd -m -r -u 999 -g chronicle chronicle
RUN mkdir -p /var/lib/chronicle \
  && chown -R chronicle:chronicle /var/lib/chronicle \
  && chmod 755 /var/lib/chronicle

WORKDIR /


# Copy untyped chronicle to image
FROM --platform=${TARGETPLATFORM} final-base AS chronicle
ARG TARGETARCH

COPY --from=artifacts /artifacts/${TARGETARCH}/chronicle /usr/local/bin
RUN chmod 755 /usr/local/bin/chronicle \
  && chown root:bin /usr/local/bin/chronicle

USER chronicle


# Copy tp to image
FROM --platform=${TARGETPLATFORM} final-base AS chronicle-tp
ARG TARGETARCH

COPY --from=artifacts /artifacts/${TARGETARCH}/chronicle_sawtooth_tp /usr/local/bin
RUN chmod 755 /usr/local/bin/chronicle_sawtooth_tp \
  && chown root:bin /usr/local/bin/chronicle_sawtooth_tp

USER chronicle
